name: Build APK (Buildozer)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Use Python 3.11 (avoid distutils removal in 3.12)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install OS packages (required by buildozer / p4a)
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk \
          build-essential autoconf automake libtool pkg-config \
          zlib1g-dev libc6-dev libncurses6 libffi-dev \
          python3-venv python3-distutils

    - name: Upgrade pip / setuptools / wheel
      run: |
        python -m pip install --upgrade pip setuptools wheel

    - name: Install Python build tools
      run: |
        python -m pip install Cython==0.29.36
        python -m pip install buildozer==1.4.3

    - name: (optional) Show python version & env
      run: |
        python --version
        which python

    - name: Ensure buildozer.spec exists (skip if you already have one)
      run: |
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi

    - name: Update buildozer.spec (customize for your app)
      run: |
        # تعديل سريع لقيم أساسية - عدّل القيم حسب حاجتك
        sed -i "s/^# title = .*$/title = HefedApp/" buildozer.spec
        sed -i "s/^# package.name = .*$/package.name = hefed/" buildozer.spec
        sed -i "s/^# package.domain = .*$/package.domain = org.example/" buildozer.spec
        sed -i "s/^# source.include_exts = .*$/source.include_exts = py,png,jpg,kv,atlas/" buildozer.spec
        sed -i "s/^# version = .*$/version = 0.1/" buildozer.spec
        sed -i "s/^# orientation = .*$/orientation = portrait/" buildozer.spec
        sed -i "s|^# requirements = .*|requirements = python3,kivy==2.3.1,kivymd==1.1.1,yt-dlp==2025.9.5,arabic-reshaper==3.0.0,python-bidi==0.6.6,plyer==2.1.0,Pillow==11.3.0|" buildozer.spec
        sed -i "s/^# android.api = .*$/android.api = 34/" buildozer.spec
        sed -i "s/^# android.ndk = .*$/android.ndk = 25b/" buildozer.spec
        sed -i "s/^# android.sdk = .*$/android.sdk = 34/" buildozer.spec
        # طبع محتوى buildozer.spec للـ logs للتأكد
        echo "---- buildozer.spec ----"
        sed -n '1,160p' buildozer.spec || true

    - name: Build APK (this will download SDK/NDK and can take long)
      run: |
        buildozer -v android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: hefed-apk
        path: bin/*.apk
        if-no-files-found: warn
